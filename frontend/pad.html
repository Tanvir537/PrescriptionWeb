<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Prescription Pad Designer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ALL YOUR EXISTING STYLES REMAIN THE SAME */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #ddd;
            --text-dark: #333;
            --text-light: #777;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --hover-bg: #f0f0f0;
        }
        
        /* ... (ALL YOUR EXISTING CSS REMAINS EXACTLY THE SAME) ... */
        
        /* ENHANCED MEDICATION STYLES FOR DYNAMIC SYSTEM */
        .medicine-entry {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .medicine-entry:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .medicine-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .timing-options {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .timing-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .timing-options input[type="checkbox"] {
            margin: 0;
        }
        
        .remove-medicine {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .remove-medicine:hover {
            background: #c0392b;
        }
        
        .add-medicine-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }
        
        .add-medicine-btn:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .medicine-input-group {
            margin-bottom: 10px;
        }
        
        .medicine-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        
        .medicine-input-group input,
        .medicine-input-group textarea,
        .medicine-input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .medicine-input-group input:focus,
        .medicine-input-group textarea:focus,
        .medicine-input-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .medicine-duration-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .medication-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .medication-preview {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .medication-preview .med-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .medication-preview .med-details {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.4;
        }
        
        .dynamic-medication-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .dynamic-medication-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .dynamic-medication-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .dynamic-medication-container::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 3px;
        }

        /* Backend Integration Styles */
        .medicine-autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 2px;
        }
        
        .medicine-autocomplete-dropdown div {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .medicine-autocomplete-dropdown div:hover {
            background-color: var(--hover-bg) !important;
        }
        
        .medicine-autocomplete-dropdown div:last-child {
            border-bottom: none !important;
        }
        
        .load-prescription-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .load-prescription-btn:hover {
            background: #2980b9;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .medicine-form-row {
                grid-template-columns: 1fr;
            }
            
            .medicine-duration-group {
                grid-template-columns: 1fr;
            }
            
            .timing-options {
                gap: 10px;
            }
        }

        /* ... (REST OF YOUR EXISTING CSS REMAINS THE SAME) ... */
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-file-medical"></i> Professional Prescription Pad Designer</h1>
        <div class="header-actions">
            <button class="btn btn-outline" id="resetBtn">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button class="btn btn-outline" id="loadBtn">
                <i class="fas fa-folder-open"></i> Load
            </button>
            <button class="btn btn-primary" id="saveBtn">
                <i class="fas fa-save"></i> Save Design
            </button>
            <button class="btn btn-success" id="downloadBtn">
                <i class="fas fa-download"></i> Download PDF
            </button>
        </div>
    </header>
    <div class="tabs">
        <div class="tab active" data-tab="page"><i class="fas fa-file"></i> Page Settings</div>
        <div class="tab" data-tab="header"><i class="fas fa-heading"></i> Header/Footer</div>
        <div class="tab" data-tab="patient"><i class="fas fa-user-edit"></i> Patient Info</div>
        <div class="tab" data-tab="layout"><i class="fas fa-th-large"></i> Layout</div>
        <div class="tab" data-tab="content"><i class="fas fa-edit"></i> Content</div>
        <div class="tab" data-tab="medication"><i class="fas fa-pills"></i> Medications</div>
        <div class="tab" data-tab="style"><i class="fas fa-palette"></i> Style</div>
        <div class="tab" data-tab="templates"><i class="fas fa-file-alt"></i> Templates</div>
    </div>
    <main>
        <aside class="sidebar">
            <!-- ALL YOUR EXISTING SIDEBAR CONTENT REMAINS THE SAME -->
            <!-- Page Settings Tab -->
            <div class="tab-content active" id="page-tab">
                <h2><i class="fas fa-file"></i> Page Settings</h2>
                <!-- ... (your existing page settings content) ... -->
            </div>
            
            <!-- Header/Footer Tab -->
            <div class="tab-content" id="header-tab">
                <h2><i class="fas fa-heading"></i> Header & Footer Settings</h2>
                <!-- ... (your existing header/footer content) ... -->
            </div>
            
            <!-- Patient Info Tab -->
            <div class="tab-content" id="patient-tab">
                <h2><i class="fas fa-user-edit"></i> Patient Info Settings</h2>
                <!-- ... (your existing patient info content) ... -->
            </div>
            
            <!-- Layout Tab -->
            <div class="tab-content" id="layout-tab">
                <h2><i class="fas fa-th-large"></i> Layout Options</h2>
                <!-- ... (your existing layout content) ... -->
            </div>
            
            <!-- Content Tab -->
            <div class="tab-content" id="content-tab">
                <h2><i class="fas fa-edit"></i> Content Sections</h2>
                <!-- ... (your existing content sections) ... -->
            </div>
            
            <!-- ENHANCED MEDICATION TAB WITH DYNAMIC SYSTEM -->
            <div class="tab-content" id="medication-tab">
                <h2><i class="fas fa-pills"></i> Medication Settings</h2>
                
                <div class="section">
                    <div class="section-title">Medication Management</div>
                    <div class="dynamic-medication-container" id="dynamicMedicationContainer">
                        <!-- Dynamic medicine entries will be added here -->
                    </div>
                    <button type="button" class="add-medicine-btn" id="addMedicineBtn">
                        <i class="fas fa-plus"></i> Add New Medicine
                    </button>
                </div>
                
                <div class="section">
                    <div class="section-title">Medication Format</div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-med-format="single">Single Line</button>
                        <button class="toggle-btn" data-med-format="multi">Multi Line</button>
                        <button class="toggle-btn" data-med-format="table">Table</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Display Options</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showMedName" checked>
                            <label for="showMedName">Medication Name</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showMedDose" checked>
                            <label for="showMedDose">Dose</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showMedDuration" checked>
                            <label for="showMedDuration">Duration</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showMedInstructions" checked>
                            <label for="showMedInstructions">Instructions</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showMedTiming" checked>
                            <label for="showMedTiming">Timing</label>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Text Styles</div>
                    <div class="line-editor">
                        <div class="line-editor-header"><span>Medicine Name</span></div>
                        <div class="form-group">
                            <label>Font Size</label>
                            <div class="measurement-controls">
                                <input type="number" id="medNameSize" class="form-control measurement-input" value="16" min="8" max="32">
                                <select id="medNameSizeUnit" class="form-control measurement-unit">
                                    <option value="px">px</option>
                                    <option value="pt">pt</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Style</label>
                            <select id="medNameStyle" class="form-control">
                                <option value="normal">Normal</option>
                                <option value="bold">Bold</option>
                                <option value="italic">Italic</option>
                            </select>
                        </div>
                    </div>
                    <!-- ... (rest of your existing style controls) ... -->
                </div>
            </div>
            
            <!-- Style Tab -->
            <div class="tab-content" id="style-tab">
                <h2><i class="fas fa-palette"></i> Style Options</h2>
                <!-- ... (your existing style content) ... -->
            </div>
            
            <!-- Templates Tab -->
            <div class="tab-content" id="templates-tab">
                <h2><i class="fas fa-file-alt"></i> Prescription Templates</h2>
                <!-- ... (your existing templates content) ... -->
            </div>
        </aside>
        
        <div class="preview-container">
            <div class="preview-header">
                <h3>Live Preview</h3>
                <div class="page-info">
                    <i class="fas fa-file"></i>
                    <span id="currentPageSize">A4 - Portrait</span>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut"><i class="fas fa-minus"></i></button>
                    <span class="zoom-value" id="zoomValue">100%</span>
                    <button class="zoom-btn" id="zoomIn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            
            <div class="prescription-pad page-a4" id="prescriptionPad">
                <div class="watermark" id="watermarkElement"></div>
                <img id="watermarkLogoElement" class="watermark-logo" src="" alt="Watermark Logo" style="display: none;">
                
                <!-- Header Section -->
                <div class="prescription-header" id="prescriptionHeader">
                    <div class="header-split" id="headerSplit">
                        <div class="header-left" id="headerLeft">
                            <div class="header-line" id="headerLeftLine1Element">Dr. Abdullah Al Noman</div>
                            <div class="header-line" id="headerLeftLine2Element">MBBS (DU), CMU</div>
                            <div class="header-line" id="headerLeftLine3Element">BMDC Reg. No.- A 137349</div>
                        </div>
                        <div class="header-right" id="headerRight">
                            <div class="header-line" id="headerRightLine1Element"></div>
                            <div class="header-line" id="headerRightLine2Element"></div>
                            <div class="header-line" id="headerRightLine3Element"></div>
                        </div>
                    </div>
                    <div class="logo-container" id="logoContainer" style="display: none;">
                        <div class="logo-placeholder">
                            <i class="fas fa-user-md fa-3x"></i>
                            <div>Logo</div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Information -->
                <div class="patient-info">
                    <div class="patient-grid">
                        <div class="patient-field">
                            <label>Name</label>
                            <input type="text" id="patientName" placeholder="Patient's Name">
                        </div>
                        <div class="patient-field">
                            <label>Age</label>
                            <input type="text" id="patientAge" placeholder="Age">
                        </div>
                        <div class="patient-field">
                            <label>Sex</label>
                            <input type="text" id="patientSex" placeholder="Sex">
                        </div>
                        <div class="patient-field" id="patientWeightContainer">
                            <label>Wt</label>
                            <input type="text" id="patientWeight" placeholder="Weight">
                        </div>
                        <div class="patient-field">
                            <label>Date</label>
                            <input type="text" id="currentDate" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- RX Symbol -->
                <div class="rx-symbol" id="rxSymbol">℞</div>
                
                <!-- ENHANCED PRESCRIPTION BODY WITH DYNAMIC MEDICATIONS -->
                <div class="prescription-body body-layout-single" id="prescriptionBody">
                    <div class="clinical-section" id="clinicalSection">
                        <!-- ... (your existing clinical sections) ... -->
                    </div>
                    
                    <div class="medication-section" id="medicationSection">
                        <div id="dynamicMedicationPreview" class="medication-list">
                            <!-- Dynamic medications will be rendered here -->
                            <div class="medication-preview-placeholder">
                                <i class="fas fa-pills"></i>
                                <p>Add medications using the sidebar controls</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Section -->
                <div class="prescription-footer" id="prescriptionFooter">
                    <div class="footer-split" id="footerSplit">
                        <div class="footer-left" id="footerLeft">
                            <div class="footer-line" id="footerLeftLine1Element">ডাঃ আবদুল্লাহ আল নোমান</div>
                            <div class="footer-line" id="footerLeftLine2Element">বাজার রোড, রামপুরা ঢাকা-১২১৯</div>
                        </div>
                        <div class="footer-right" id="footerRight">
                            <div class="footer-line" id="footerRightLine1Element">বিকাল ৪টা - রাত ৮টা</div>
                            <div class="footer-line" id="footerRightLine2Element">মোবাইলঃ ০১৬২৩-৬০৩৬৮০</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Changes saved successfully!</span>
    </div>

    <script>
        // MEDICINE ENTRY TEMPLATE - YOUR BASE PRESCRIPTION SYSTEM
        const medicineTemplate = (index = 0) => `
            <div class="medicine-entry" data-index="${index}">
                <button type="button" class="remove-medicine" onclick="removeMedicine(${index})">
                    <i class="fas fa-times"></i> Remove
                </button>
                
                <div class="medicine-form-row">
                    <div class="medicine-input-group">
                        <label for="medicineName_${index}">Medicine Name *</label>
                        <input type="text" id="medicineName_${index}" name="medicine_name" 
                               placeholder="e.g., Amoxicillin" required
                               oninput="updateMedicinePreview(${index})">
                    </div>
                    
                    <div class="medicine-input-group">
                        <label for="medicineDosage_${index}">Dosage *</label>
                        <input type="text" id="medicineDosage_${index}" name="dosage" 
                               placeholder="e.g., 500mg" required
                               oninput="updateMedicinePreview(${index})">
                    </div>
                </div>
                
                <div class="medicine-input-group">
                    <label>Timing</label>
                    <div class="timing-options">
                        <label>
                            <input type="checkbox" name="morning" id="morning_${index}" 
                                   onchange="updateMedicinePreview(${index})"> Morning
                        </label>
                        <label>
                            <input type="checkbox" name="afternoon" id="afternoon_${index}" 
                                   onchange="updateMedicinePreview(${index})"> Afternoon
                        </label>
                        <label>
                            <input type="checkbox" name="evening" id="evening_${index}" 
                                   onchange="updateMedicinePreview(${index})"> Evening
                        </label>
                        <label>
                            <input type="checkbox" name="night" id="night_${index}" 
                                   onchange="updateMedicinePreview(${index})"> Night
                        </label>
                    </div>
                </div>
                
                <div class="medicine-form-row">
                    <div class="medicine-input-group">
                        <label for="medicineFrequency_${index}">Frequency</label>
                        <input type="text" id="medicineFrequency_${index}" name="frequency" 
                               placeholder="e.g., 3 times daily"
                               oninput="updateMedicinePreview(${index})">
                    </div>
                    
                    <div class="medicine-input-group">
                        <label for="medicineDuration_${index}">Duration (days)</label>
                        <input type="number" id="medicineDuration_${index}" name="duration_days" 
                               placeholder="e.g., 7" min="1"
                               oninput="updateMedicinePreview(${index})">
                    </div>
                </div>
                
                <div class="medicine-input-group">
                    <label for="medicineMeal_${index}">Meal Relation</label>
                    <select id="medicineMeal_${index}" name="meal_relation" onchange="updateMedicinePreview(${index})">
                        <option value="">Select timing</option>
                        <option value="before">Before Meal</option>
                        <option value="after">After Meal</option>
                        <option value="with">With Meal</option>
                    </select>
                </div>
                
                <div class="medicine-input-group">
                    <label for="medicineNotes_${index}">Additional Notes</label>
                    <textarea id="medicineNotes_${index}" name="notes" rows="2" 
                              placeholder="Special instructions, side effects, etc."
                              oninput="updateMedicinePreview(${index})"></textarea>
                </div>
                
                <div class="medication-preview" id="medicinePreview_${index}">
                    <div class="med-name">Medicine preview will appear here</div>
                </div>
            </div>
        `;

        let medicineCount = 0;
        const medicines = [];

        // ==================== BACKEND INTEGRATION ====================
        const API_BASE = 'http://localhost:3001/api';

        // Initialize database
        async function initializeDatabase() {
            try {
                const response = await fetch(`${API_BASE}/init-db`);
                const data = await response.json();
                console.log('Database initialized:', data.message);
            } catch (error) {
                console.error('Database initialization failed:', error);
            }
        }

        // Save prescription pad to backend
        async function savePrescriptionPadToBackend() {
            const patientInfo = {
                name: document.getElementById('patientName').value || '',
                age: document.getElementById('patientAge').value || '',
                sex: document.getElementById('patientSex').value || '',
                weight: document.getElementById('patientWeight').value || '',
                date: document.getElementById('currentDate').value || ''
            };

            const designData = {
                pageSize: document.getElementById('pageSize').value,
                orientation: document.querySelector('[data-orientation].active').dataset.orientation,
                headerLayout: document.querySelector('[data-header-layout].active')?.dataset.headerLayout || 'split',
                footerLayout: document.querySelector('[data-footer-layout].active')?.dataset.footerLayout || 'split',
            };

            const saveData = {
                designData: designData,
                medications: medicines.filter(med => med && (med.name || med.dosage)),
                patientInfo: patientInfo
            };

            try {
                const response = await fetch(`${API_BASE}/prescription-pad/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });

                const result = await response.json();
                showNotification(`Prescription saved to database! ID: ${result.id}`);
                return result.id;
            } catch (error) {
                console.error('Failed to save prescription pad:', error);
                showNotification('Failed to save to database - using local storage only');
                return null;
            }
        }

        // Load prescription pad from backend
        async function loadPrescriptionPadFromBackend(id) {
            try {
                const response = await fetch(`${API_BASE}/prescription-pad/load/${id}`);
                if (!response.ok) {
                    throw new Error('Failed to load prescription');
                }
                const data = await response.json();
                
                // Restore patient info
                if (data.patientInfo) {
                    document.getElementById('patientName').value = data.patientInfo.name || '';
                    document.getElementById('patientAge').value = data.patientInfo.age || '';
                    document.getElementById('patientSex').value = data.patientInfo.sex || '';
                    document.getElementById('patientWeight').value = data.patientInfo.weight || '';
                }

                // Restore medications
                if (data.medications && data.medications.length > 0) {
                    // Clear existing medications
                    const container = document.getElementById('dynamicMedicationContainer');
                    container.innerHTML = '';
                    medicines.length = 0;
                    medicineCount = 0;

                    // Add loaded medications
                    data.medications.forEach((med, index) => {
                        addNewMedicine();
                        // Use setTimeout to ensure DOM is updated
                        setTimeout(() => {
                            const nameInput = document.getElementById(`medicineName_${index}`);
                            if (nameInput) {
                                nameInput.value = med.name || '';
                                document.getElementById(`medicineDosage_${index}`).value = med.dosage || '';
                                document.getElementById(`medicineFrequency_${index}`).value = med.frequency || '';
                                document.getElementById(`medicineDuration_${index}`).value = med.duration || '';
                                document.getElementById(`medicineMeal_${index}`).value = med.meal || '';
                                document.getElementById(`medicineNotes_${index}`).value = med.notes || '';
                                
                                if (med.timing) {
                                    document.getElementById(`morning_${index}`).checked = med.timing.morning || false;
                                    document.getElementById(`afternoon_${index}`).checked = med.timing.afternoon || false;
                                    document.getElementById(`evening_${index}`).checked = med.timing.evening || false;
                                    document.getElementById(`night_${index}`).checked = med.timing.night || false;
                                }
                                
                                updateMedicinePreview(index);
                            }
                        }, 50);
                    });
                }

                showNotification('Prescription loaded from database!');
            } catch (error) {
                console.error('Failed to load prescription pad:', error);
                showNotification('Failed to load from database');
            }
        }

        // Medicine autocomplete search
        async function searchMedicines(query) {
            if (!query || query.length < 2) return [];

            try {
                const response = await fetch(`${API_BASE}/pad/medicines/autocomplete?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                const medicines = await response.json();
                return medicines;
            } catch (error) {
                console.error('Medicine search failed:', error);
                return [];
            }
        }

        // Enhanced save function that saves to both localStorage and backend
        async function enhancedSaveDesign() {
            // First save to localStorage (your existing functionality)
            const designData = {
                medications: medicines.filter(med => med && (med.name || med.dosage)),
                medicineCount: medicineCount
            };
            
            localStorage.setItem('prescriptionPadDesign', JSON.stringify(designData));
            
            // Then save to backend
            await savePrescriptionPadToBackend();
            
            showNotification('Design saved locally and to database!');
        }

        // Medicine autocomplete functionality
        function initializeMedicineAutocomplete() {
            document.addEventListener('input', function(e) {
                if (e.target.id && e.target.id.startsWith('medicineName_')) {
                    const input = e.target;
                    const query = input.value.trim();
                    
                    // Clear previous timeout
                    if (input.autocompleteTimeout) {
                        clearTimeout(input.autocompleteTimeout);
                    }
                    
                    // Debounce search
                    input.autocompleteTimeout = setTimeout(() => {
                        if (query.length >= 2) {
                            searchMedicines(query).then(medicines => {
                                showMedicineAutocomplete(input, medicines);
                            });
                        } else {
                            hideMedicineAutocomplete(input);
                        }
                    }, 300);
                }
            });

            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.matches('.medicine-autocomplete-dropdown, .medicine-autocomplete-dropdown *')) {
                    hideAllAutocompleteDropdowns();
                }
            });
        }

        function showMedicineAutocomplete(input, medicines) {
            // Remove existing dropdown
            hideMedicineAutocomplete(input);
            
            if (medicines.length === 0) return;
            
            const dropdown = document.createElement('div');
            dropdown.className = 'medicine-autocomplete-dropdown';
            dropdown.style.width = `${input.offsetWidth}px`;
            
            medicines.forEach(medicine => {
                const item = document.createElement('div');
                item.innerHTML = `
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 2px;">
                        ${medicine.generic_name}
                    </div>
                    <div style="font-size: 12px; color: var(--text-light); margin-bottom: 2px;">
                        <strong>Brands:</strong> ${medicine.brand_names?.slice(0, 3).join(', ') || 'N/A'}
                    </div>
                    <div style="font-size: 11px; color: var(--text-light);">
                        ${medicine.dosage_form || ''} | ${medicine.strength || ''}
                    </div>
                `;
                item.addEventListener('click', () => {
                    input.value = medicine.generic_name;
                    hideMedicineAutocomplete(input);
                    
                    // Auto-fill dosage field
                    const index = input.id.split('_')[1];
                    const dosageInput = document.getElementById(`medicineDosage_${index}`);
                    if (dosageInput && medicine.strength) {
                        dosageInput.value = medicine.strength;
                    }
                    
                    updateMedicinePreview(parseInt(index));
                });

                item.addEventListener('mouseenter', () => {
                    item.style.backgroundColor = 'var(--hover-bg)';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.backgroundColor = '';
                });

                dropdown.appendChild(item);
            });
            
            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(dropdown);
        }

        function hideMedicineAutocomplete(input) {
            const existing = input.parentNode.querySelector('.medicine-autocomplete-dropdown');
            if (existing) {
                existing.remove();
            }
        }

        function hideAllAutocompleteDropdowns() {
            document.querySelectorAll('.medicine-autocomplete-dropdown').forEach(dropdown => {
                dropdown.remove();
            });
        }

        // Load saved prescription pads list
        async function loadSavedPrescriptionPads() {
            try {
                const response = await fetch(`${API_BASE}/prescription-pads`);
                const pads = await response.json();
                return pads;
            } catch (error) {
                console.error('Failed to load prescription pads list:', error);
                return [];
            }
        }

        // Show modal to load saved prescriptions
        async function showLoadPrescriptionModal() {
            const pads = await loadSavedPrescriptionPads();
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            modalContent.innerHTML = `
                <h3>Load Saved Prescription</h3>
                <div id="prescriptionList">
                    ${pads.length === 0 ? '<p>No saved prescriptions found</p>' : ''}
                    ${pads.map(pad => `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                            <strong>${pad.patientInfo?.name || 'Unnamed Patient'}</strong><br>
                            <small>Age: ${pad.patientInfo?.age || 'N/A'}, Date: ${new Date(pad.createdAt).toLocaleDateString()}</small>
                            <button onclick="loadPrescriptionPadFromBackend(${pad.id}); this.closest('div').closest('div').closest('div').remove()" class="load-prescription-btn">
                                Load
                            </button>
                        </div>
                    `).join('')}
                </div>
                <button onclick="this.closest('div').closest('div').remove()" style="margin-top: 10px; padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            `;
            
            modal.appendChild(modalContent);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            document.body.appendChild(modal);
        }

        // ==================== EXISTING MEDICATION SYSTEM ====================

        // Initialize the dynamic medication system
        function initializeDynamicMedicationSystem() {
            const container = document.getElementById('dynamicMedicationContainer');
            const addButton = document.getElementById('addMedicineBtn');
            
            // Add first medicine entry
            addNewMedicine();
            
            // Add medicine button event
            addButton.addEventListener('click', addNewMedicine);
            
            // Initialize display options
            initializeMedicationDisplayOptions();
        }

        function addNewMedicine() {
            const container = document.getElementById('dynamicMedicationContainer');
            const newEntry = document.createElement('div');
            newEntry.innerHTML = medicineTemplate(medicineCount);
            container.appendChild(newEntry);
            
            // Initialize the medicine object
            medicines[medicineCount] = {
                name: '',
                dosage: '',
                timing: { morning: false, afternoon: false, evening: false, night: false },
                frequency: '',
                duration: '',
                meal: '',
                notes: ''
            };
            
            medicineCount++;
            updateMedicationPreview();
        }

        function removeMedicine(index) {
            if (medicineCount <= 1) {
                showNotification('At least one medicine entry is required');
                return;
            }
            
            const entry = document.querySelector(`.medicine-entry[data-index="${index}"]`);
            if (entry) {
                entry.remove();
                delete medicines[index];
                medicineCount--;
                updateMedicationPreview();
            }
        }

        function updateMedicinePreview(index) {
            const medicine = medicines[index];
            if (!medicine) return;
            
            // Update medicine object with current values
            medicine.name = document.getElementById(`medicineName_${index}`).value;
            medicine.dosage = document.getElementById(`medicineDosage_${index}`).value;
            medicine.frequency = document.getElementById(`medicineFrequency_${index}`).value;
            medicine.duration = document.getElementById(`medicineDuration_${index}`).value;
            medicine.meal = document.getElementById(`medicineMeal_${index}`).value;
            medicine.notes = document.getElementById(`medicineNotes_${index}`).value;
            
            // Update timing
            medicine.timing.morning = document.getElementById(`morning_${index}`).checked;
            medicine.timing.afternoon = document.getElementById(`afternoon_${index}`).checked;
            medicine.timing.evening = document.getElementById(`evening_${index}`).checked;
            medicine.timing.night = document.getElementById(`night_${index}`).checked;
            
            // Update individual preview
            updateIndividualPreview(index);
            
            // Update main prescription preview
            updateMainMedicationPreview();
        }

        function updateIndividualPreview(index) {
            const medicine = medicines[index];
            const previewElement = document.getElementById(`medicinePreview_${index}`);
            
            if (!medicine.name && !medicine.dosage) {
                previewElement.innerHTML = '<div class="med-name">Medicine preview will appear here</div>';
                return;
            }
            
            let previewHTML = '';
            
            if (medicine.name) {
                previewHTML += `<div class="med-name">${medicine.name}</div>`;
            }
            
            let details = [];
            if (medicine.dosage) details.push(medicine.dosage);
            
            // Add timing
            const timingParts = [];
            if (medicine.timing.morning) timingParts.push('Morning');
            if (medicine.timing.afternoon) timingParts.push('Afternoon');
            if (medicine.timing.evening) timingParts.push('Evening');
            if (medicine.timing.night) timingParts.push('Night');
            
            if (timingParts.length > 0) {
                details.push(timingParts.join('/'));
            }
            
            if (medicine.frequency) details.push(medicine.frequency);
            if (medicine.meal) details.push(`${medicine.meal} meal`);
            if (medicine.duration) details.push(`${medicine.duration} days`);
            if (medicine.notes) details.push(medicine.notes);
            
            if (details.length > 0) {
                previewHTML += `<div class="med-details">${details.join(' - ')}</div>`;
            }
            
            previewElement.innerHTML = previewHTML;
        }

        function updateMainMedicationPreview() {
            const previewContainer = document.getElementById('dynamicMedicationPreview');
            let previewHTML = '';
            
            medicines.forEach((medicine, index) => {
                if (!medicine.name && !medicine.dosage) return;
                
                let medicineHTML = '<div class="medication-item">';
                
                if (medicine.name) {
                    medicineHTML += `<div class="med-name">${medicine.name}</div>`;
                }
                
                let details = [];
                if (medicine.dosage) details.push(medicine.dosage);
                
                // Add timing
                const timingParts = [];
                if (medicine.timing.morning) timingParts.push('M');
                if (medicine.timing.afternoon) timingParts.push('A');
                if (medicine.timing.evening) timingParts.push('E');
                if (medicine.timing.night) timingParts.push('N');
                
                if (timingParts.length > 0) {
                    details.push(timingParts.join('+'));
                }
                
                if (medicine.frequency) details.push(medicine.frequency);
                if (medicine.meal) details.push(`${medicine.meal} meal`);
                if (medicine.duration) details.push(`${medicine.duration} days`);
                if (medicine.notes) details.push(medicine.notes);
                
                if (details.length > 0) {
                    medicineHTML += `<div class="med-details">${details.join(' - ')}</div>`;
                }
                
                medicineHTML += '</div>';
                previewHTML += medicineHTML;
            });
            
            if (previewHTML === '') {
                previewHTML = `
                    <div class="medication-preview-placeholder">
                        <i class="fas fa-pills"></i>
                        <p>Add medications using the sidebar controls</p>
                    </div>
                `;
            }
            
            previewContainer.innerHTML = previewHTML;
        }

        function initializeMedicationDisplayOptions() {
            // Add event listeners for display toggles
            document.getElementById('showMedName').addEventListener('change', updateMedicationDisplay);
            document.getElementById('showMedDose').addEventListener('change', updateMedicationDisplay);
            document.getElementById('showMedDuration').addEventListener('change', updateMedicationDisplay);
            document.getElementById('showMedInstructions').addEventListener('change', updateMedicationDisplay);
            document.getElementById('showMedTiming').addEventListener('change', updateMedicationDisplay);
        }

        function updateMedicationDisplay() {
            // This function would handle showing/hiding specific medication details
            // based on the checkbox states
            updateMainMedicationPreview();
        }

        // Notification function
        function showNotification(text) {
            const n = document.getElementById('notification');
            document.getElementById('notificationText').textContent = text;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize backend first
            initializeDatabase();
            
            // Then initialize your existing systems
            initializeDynamicMedicationSystem();
            initializeMedicineAutocomplete();
            
            // Update save button to use enhanced save
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', enhancedSaveDesign);
            }
            
            // Add load button functionality
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) {
                loadBtn.addEventListener('click', showLoadPrescriptionModal);
            }
            
            // Set current date
            const today = new Date();
            const formattedDate = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
            document.getElementById('currentDate').value = formattedDate;
            
            // ... rest of your existing initialization code ...
        });
    </script>
</body>
</html>